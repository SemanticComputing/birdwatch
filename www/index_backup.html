<!DOCTYPE html> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" 
lang="en">
  
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />

    <title class="transl" data-fi="Semanttinen havaintopalvelu" data-en="Semantic Observation Service"></title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="" />
    <meta name="author" content="" />

    <link href="jquery-ui/css/ui-lightness/jquery-ui-1.8.21.custom.css" rel="stylesheet">
    <link href="jquery.mobile-1.1.0.min.css" rel="stylesheet">
    <!--<link rel="stylesheet" href="themes/pulsar.min.css" />-->
    <!--<link rel="stylesheet" href="http://code.jquery.com/mobile/1.1.1/jquery.mobile.structure-1.1.1.min.css" />-->
    <!--<link rel="stylesheet" href="themes/Kerpo.min.css" />-->

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

	<script src="jquery/jquery-1.7.2.min.js"></script>
	<script src="jquery-ui/js/jquery-ui-1.8.21.custom.min.js"></script>
	<script src="jquery.mobile-1.1.0.min.js"></script>
	
	<style type="text/css">
	.rightAlign {
		text-align:right;
		}
    html { background-color: #F8F0F0; }
    
    .ui-btn-up-f, .ui-btn-hover-f, .ui-btn-down-f {
	  color: white;
	  font-weight: bold;
	  text-decoration: none; }

	.ui-btn-up-f {
	  border: 1px solid #711414;
	  background: #ab2525;
	  text-shadow: 0 -1px 1px #711414;
	  background-image: -moz-linear-gradient(top, #c44f4f, #ab2525);
	  background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0, #c45e5e), color-stop(1, #9e3939));
	  -ms-filter: "progid:DXImageTransform.Microsoft.gradient(startColorStr='#c44f4f', EndColorStr='#ab2525')"; }

	.ui-btn-hover-f {
	  border: 1px solid #6e0000;
	  background: #b54a4a;
	  text-shadow: 0 -1px 1px #690101;
	  background-image: -moz-linear-gradient(top, #d47272, #b54a4a);
	  background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0, #d47272), color-stop(1, #b54a4a));
	  -ms-filter: "progid:DXImageTransform.Microsoft.gradient(startColorStr='#d47272', EndColorStr='#b54a4a')"; }

	.ui-btn-down-f {
	  border: 1px solid #782323;
	  background: #c44f4f;
	  text-shadow: 0 -1px 1px #782323;
	  background-image: -moz-linear-gradient(top, #9e3939, #c44f4f);
	  background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0, #9e3939), color-stop(1, #c44f4f));
	  -ms-filter: "progid:DXImageTransform.Microsoft.gradient(startColorStr='#9e3939', EndColorStr='#c44f4f')"; }
	  
	.ui-btn-up-g, .ui-btn-hover-g, .ui-btn-down-g
	{
	color: white;
	font-weight: bold;
	text-decoration: none;
	}

	.ui-btn-up-g
	{
	border: 1px solid #397114;
	background: #5aab25;
	text-shadow: 0 -1px 1px #397114;
	background-image: -moz-linear-gradient(top, #7ec44f, #5aab25);
	background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0, #87c45e), color-stop(1, #619e39));
	-ms-filter: "progid:DXImageTransform.Microsoft.gradient(startColorStr='#7ec44f', EndColorStr='#5aab25')";
	}

	.ui-btn-hover-g
	{
	border: 1px solid #2c6e00;
	background: #75b54a;
	text-shadow: 0 -1px 1px #2a6901;
	background-image: -moz-linear-gradient(top, #99d472, #75b54a);
	background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0, #99d472), color-stop(1, #75b54a));
	-ms-filter: "progid:DXImageTransform.Microsoft.gradient(startColorStr='#99d472', EndColorStr='#75b54a')";
	}

	.ui-btn-down-g
	{
	border: 1px solid #457823;
	background: #7ec44f;
	text-shadow: 0 -1px 1px #457823;
	background-image: -moz-linear-gradient(top, #619e39, #7ec44f);
	background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0, #619e39), color-stop(1, #7ec44f));
	-ms-filter: "progid:DXImageTransform.Microsoft.gradient(startColorStr='#619e39', EndColorStr='#7ec44f')";
	}

	.ui-btn-up-g, .ui-btn-hover-g, .ui-btn-down-g
	{
	color: white;
	font-weight: bold;
	text-decoration: none;
	}
    </style>
    <style type='text/css'>
    <!--
        @media only screen and (min-width: 801px){
            .ui-page {
                width: 700px !important;
                margin: 0 auto !important;
                position: relative !important;
                border-right: 1px #CCCCCC solid !important;
                border-left: 1px #CCCCCC solid !important;
            }
        }
    -->
	</style>

  </head>

<body>
<div data-role="page" class="type-home">
    <div id="headDiv" data-role="header" data-theme="e">
		<h1 class="ui-title transl" data-fi="Havainto" data-en="Observation"></h1>
    </div>

	<div class="ui-body ui-body-b" id="mainDiv">
		<label for="taxonInput" class="transl" data-fi="Laji" data-en="Species"></label>
		<input id="taxonInput" class="ui-autocomplete-input" />
		<label for="locationInput" class="transl" data-fi="Paikka" data-en="Location"></label>
		<input id="locationInput" type="text" />
		<label for="datepicker" class="select transl" data-fi="Aika" data-en="Date"></label>
		<input name="date1" id="datepicker" type="text" />
		
		<label for="select-choice-1" class="select transl" data-fi="Biotooppi" data-en="Biotope"></label>
		<select name="biotope" id="select-choice-1" data-mini="true" data-theme="c">
			<option value="-"></option>
			<option value="ulkosaaristo" class="transl" data-fi="ulkosaaristo" data-en="archipelago"></option>
			<option value="meri" class="transl" data-fi="meri" data-en="sea"></option>
			<option value="jarvitaijoki" class="transl" data-fi="järvi/joki" data-en="lake/river"></option>
			<option value="tunturi" class="transl" data-fi="tunturi" data-en="fell"></option>
			<option value="metsa" class="transl" data-fi="metsä" data-en="forest"></option>
			<option value="peltotaiavomaa" class="transl" data-fi="pelto/avomaa" data-en="field"></option>
			<option value="suo" class="transl" data-fi="suo" data-en="bog"></option>
			<option value="asutus" class="transl" data-fi="asutus" data-en="urban area"></option>
		</select>
		
		<div class="ui-grid-a">
			<div class="ui-block-a">
				<a data-inline="true" data-role="button" href="#" onClick="getResults();" data-theme="e">
					<span class="ui-btn-text transl" data-fi="OK" data-en="OK"></span>
				</a>
			</div>
			<div class="ui-block-b rightAlign">
				<a data-inline="true" data-role="button" href="#" onClick="langEn();" data-theme="c" id="engBut">
					<span class="ui-btn-text">in english</span>
				</a>
				<a data-inline="true" data-role="button" href="#" onClick="langFi();" data-theme="c" id="finBut">
					<span class="ui-btn-text">suomeksi</span>
				</a>
				<a data-inline="true" data-role="button" href="#" onClick="displayInfo();" data-theme="e" id="infoBut">
					<span class="ui-btn-text">?</span>
				</a>
			</div>
		</div>
		
		<!--Hae lajin tiedot</button>-->
		<p id="speciesHolder"></p>
		<p id="resultHolder"></p>
		<p id="resultHolder2"></p>
		<p id="buttHolder"></p>
		<p id="infoHolder" class="transl" data-fi="" data-en=""></p>
	</div>

	<script>
		Date.prototype.getDOY = function() {
			var onejan = new Date(this.getFullYear(),0,1);
			return Math.ceil((this - onejan) / 86400000);
		} 
		
		var sparql_url = "mt08014.seco.hut.fi:9080/smetana/service/data/Pulsa3/sparql?query=";
		
		var d = new Date();
		var year = d.getFullYear();
		var month = (d.getMonth() + 1);
		var date = d.getDate();
		
		var lang;
		
		var speciesLat = [];
		var speciesEn = [];
		var speciesFi = [];
		
		var taxId;
		
		langEn();
		
		/** Display help text */
		function displayInfo() {
			document.getElementById("speciesHolder").innerHTML = "";
			document.getElementById("resultHolder").innerHTML = "";
			document.getElementById("resultHolder2").innerHTML = "";
			document.getElementById("buttHolder").innerHTML = "";

			var r = document.getElementById("infoHolder");
			
			if ((r.innerHTML.length > 0) && 
				((r.innerHTML.substring(0,7) == '<b>Ohje' && lang == 'fi') || (r.innerHTML.substring(0,7) == '<b>Help' && lang == 'en'))) {
				r.innerHTML = "";
			} else {
				if (lang == 'fi') {
					r.innerHTML = "<b>Laji</b> - havaittu laji<br />";
					r.innerHTML = "<b>Laji</b> - havaittu laji<br />";
					r.innerHTML += "<b>Paikka</b> - havainnon paikka, koordinaatit tai teksti. Esim. \"Laajalahti, Espoo\"<br />";
					r.innerHTML += "<b>Aika</b> - havainnon aika<br />";
					r.innerHTML += "<b>Biotooppi</b> - biotooppi, jossa laji on havaittu<br />";
				}
				if (lang == 'en') {
					r.innerHTML = "<b>Species</b> - observed species<br />";
					r.innerHTML += "<b>Location</b> - observation location in coordinates or text. Example: \"Laajalahti, Espoo\"<br />";
					r.innerHTML += "<b>Time</b> - observation time<br />";
					r.innerHTML += "<b>Biotope</b> - observation biotope<br />";
				}
			}
		}
		
		/** Set language to finnish */
		function langFi() {
			$('.transl').each( function() {
				$(this).html( $(this).data('fi'));
			});
			lang = 'fi';
			$("#taxonInput").autocomplete({
				minLength: 2,
				source: speciesFi.concat( speciesLat )
			});
			
			$('#select-choice-1')[ 0 ].value = '-';
			$.getScript("jquery-ui/js/jquery.ui.datepicker-fi.js", function(){ });

		}
		
		/** Set language to english */
		function langEn() {
			$('.transl').each( function() {
				$(this).html( $(this).data('en'));
			});
			lang = 'en';
			$("#taxonInput").autocomplete({
				minLength: 2,
				source: speciesEn.concat( speciesLat )
			});

			$.getScript("jquery-ui/js/jquery.ui.datepicker-en-GB.js", function(){ });
		}
		
		/** Datepicker code */
		$( "#datepicker" ).datepicker({ dateFormat: "dd.mm.yy" });
		$('div.ui-datepicker').css({ fontSize: '12px' });
		
		if (date.toString().length == 1)
			date = "0" + date;
		if (month.toString().length == 1)
			month = "0" + month;
			
		/** Get the HTML DOM Object from jQuery Object and update with current date */
		$( "#datepicker" )[0].value = date + "." + month + "." + year;
		
		/** Get latin taxon-names */
		$.ajax({
			url: "relay_JSON.php",
			data: { url: sparql_url + 
				encodeURIComponent("PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> PREFIX taxmeon: <http://www.yso.fi/onto/taxmeon/> PREFIX taxonomic-ranks: <http://www.yso.fi/onto/taxonomic-ranks/>" + 
				"SELECT DISTINCT ?label WHERE { ?resource rdf:type taxmeon:TaxonInChecklist . ?resource rdf:type taxonomic-ranks:Species . ?resource rdfs:label ?label . FILTER (lang(?label) != \"en\" && lang(?label) != \"fi\") } " + 
				"ORDER BY ?label") },
			success: function(data) {
				var obj = $.parseJSON(data);

				for (x in obj.results.result) {
					speciesLat.push( obj.results.result[ x ].binding.literal.toLowerCase() );
				}

				$("#taxonInput").autocomplete({
					minLength: 2,
					source: speciesEn.concat( speciesLat )
				});
			}
		});
		
		/** Get english taxon-names */
		$.ajax({
			url: "relay_JSON.php",
			data: { url: sparql_url + 
				encodeURIComponent("PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> PREFIX taxmeon: <http://www.yso.fi/onto/taxmeon/> PREFIX taxonomic-ranks: <http://www.yso.fi/onto/taxonomic-ranks/>" + 
				"SELECT DISTINCT ?label WHERE { ?resource rdf:type taxmeon:VernacularName . ?resource taxmeon:inverse_of_hasVernacularName ?resource0 . ?resource0 rdf:type taxonomic-ranks:Species . ?resource rdfs:label ?label . FILTER (lang(?label) = \"en\") } " + 
				"ORDER BY ?label ") },
			success: function(data) {
				var obj = $.parseJSON(data);

				for (x in obj.results.result) {
					speciesEn.push( obj.results.result[ x ].binding.literal.toLowerCase() );
				}

				$("#taxonInput").autocomplete({
					minLength: 2,
					source: speciesEn.concat( speciesLat )
				});
			}
		});
		
		/** Get finnish taxon-names */
		$.ajax({
			url: "relay_JSON.php",
			data: { url: sparql_url + 
				encodeURIComponent("PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> PREFIX taxmeon: <http://www.yso.fi/onto/taxmeon/> PREFIX taxonomic-ranks: <http://www.yso.fi/onto/taxonomic-ranks/>" + 
				"SELECT DISTINCT ?label WHERE { ?resource rdf:type taxmeon:VernacularName . ?resource taxmeon:inverse_of_hasVernacularName ?resource0 . ?resource0 rdf:type taxonomic-ranks:Species . ?resource rdfs:label ?label . FILTER (lang(?label) = \"fi\") } " + 
				"ORDER BY ?label ") },
			success: function(data) {
				var obj = $.parseJSON(data);

				for (x in obj.results.result) {
					speciesFi.push( obj.results.result[ x ].binding.literal.toLowerCase() );
				}

			}
		});


		function changeTaxon( tax ) {
			document.getElementById("taxonInput").value = tax
			getResults();
		}
		
		
		/** Get results from form */
		function getResults() {
			var loc = "";

			document.getElementById("infoHolder").innerHTML = "";
			
			var tax = document.getElementById("taxonInput").value.toLowerCase();
			var latinName = false;

			var biotope = document.getElementById("select-choice-1").value.toLowerCase();
			
			if ( $.inArray( tax, speciesLat ) != -1 ) {
				latinName = true;
			}
			
			if (document.getElementById("locLat") !== null) {
				loc = "Lat: " + document.getElementById("locLat").value + 
					" Lon: " + document.getElementById("locLon").value;
			} else {
				loc = document.getElementById("locationInput").value;
			}

			var dateArr = document.getElementById("datepicker").value.split('.');
			
			date = dateArr[ 0 ];
			month = dateArr[ 1 ];
			year = '2012';
			selectedDate = new Date( year, month, date, 0, 0, 0, 0 );

			if (date.toString().length == 1)
				date = "0" + date;
			if (month.toString().length == 1)
				month = "0" + month;
			
			/** Capitalize all separate words */
			function capitalizeWords(strSentence) {
				var s = strSentence.replace(/\s[a-z]/g, convertToUpper);
				s = s[ 0 ].toUpperCase() + s.substring(1);

				return s;
			 
				function convertToUpper() {
					return arguments[0].toUpperCase();
				}
			}
			
			/** Capitalize first letter */
			function capitalizeFirst(strSentence) {
				return strSentence[ 0 ].toUpperCase() + strSentence.substring(1);
			}
			
			/** Generate misid-text */
			function speciesLinks( speciesName, bLink, bLuontoPortti ) {
				var thisStr = '';
				
				if ( bLink )
					thisStr = '<a href href="#" onClick="changeTaxon(\'' + speciesName + '\');">';
				else
					thisStr = '<b>';
					
				if (lang == 'en')
					thisStr += capitalizeWords( speciesName );
				else
					thisStr += speciesName;
					
				if ( bLink )
					thisStr += '</a>';
				else
					thisStr += '</b>';
								
				var speciesLP = speciesName.replace(/ä/g, "a").replace(/ö/g, "o")
				if (lang == 'fi')
					speciesLP = speciesLP.replace('isokuovi','kuovi');
				else {
					speciesLP = speciesLP.split('/')[ 0 ];
					speciesLP = speciesLP.replace('northern pintail', 'pintail').replace('common teal', 'teal');
					speciesLP = speciesLP.replace('barn swallow','swallow').replace('collared sand martin','sand martin');
					speciesLP = speciesLP.replace('eurasian ', '').replace('european ', '');
					speciesLP = speciesLP.replace(/ /g,'-');
				}
				
				var validTaxon = false;
				
				//console.log( speciesName );
				
				//if ( lang == 'en' && (($.inArray( tax, speciesEn ) != -1) || ($.inArray( tax, speciesLat ) != -1))) {
				if ( lang == 'en' && ($.inArray( speciesName, speciesEn ) != -1)) {
					validTaxon = true;
				}
			
				if ( lang == 'fi' && ($.inArray( speciesName, speciesFi ) != -1)) {
					validTaxon = true;
				}
			
				if ( validTaxon ) {
					thisStr += " &nbsp; <a href=\"http://" + lang + ".wikipedia.org/wiki/" + capitalizeWords( speciesName.split('/')[ 0 ] ) + "\" target=\"_blank\" title=\"Wikipedia\"><img src=\"w.ico\" /></a>";
					//if (lang == 'fi')
					
					if ( bLuontoPortti )
						thisStr += " <a id=\"lp_" + speciesName + "\" href=\"http://www.luontoportti.com/suomi/" + lang + "/linnut/" + speciesLP + "\" target=\"_blank\" title=\"Luontoportti\"><img src=\"lp.ico\" /></a>";
					//$('#lp_' + speciesName).hide();
					
					if (lang == 'fi')
						thisStr += " <a href=\"http://atlas3.lintuatlas.fi/tulokset/laji/" + speciesName + "\" target=\"_blank\" title=\"Lintuatlas\"><img src=\"atlas.ico\" /></a>";

				}
				thisStr += "<br />";
				
				return thisStr;
			}

			/** create SPARQL-query for retrieving misidentifications */
			
			var sparqlQuery;
			
			if ( !latinName ) {
				sparqlQuery = "PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> PREFIX hh: <http://www.hatikka.fi/havainnot/> PREFIX envirofi: <http://www.yso.fi/onto/envirofi/> PREFIX taxmeon: <http://www.yso.fi/onto/taxmeon/> " + 
					"SELECT ?resource ?label ?common ?origcommon WHERE { ?resource0 envirofi:hasCommonMisidentification ?misid . ?resource0 hh:general ?origcommon . ?resource hh:general ?common . ?resource envirofi:hasCommonMisidentification ?misid . ?vern0 taxmeon:inverse_of_hasVernacularName ?resource0 . ?vern0 rdfs:label \"" + tax + "\"@" + lang + " . ?resource taxmeon:hasVernacularName ?vern . ?vern rdfs:label ?label . FILTER ( ?resource0 != ?resource ) . FILTER (lang(?label) = \"" + lang + "\") }";
			} else {
				sparqlQuery = "PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> PREFIX hh: <http://www.hatikka.fi/havainnot/> PREFIX envirofi: <http://www.yso.fi/onto/envirofi/> PREFIX taxmeon: <http://www.yso.fi/onto/taxmeon/> " + 
					"SELECT ?resource ?label ?common ?origcommon WHERE { ?resource0 envirofi:hasCommonMisidentification ?misid . ?resource0 hh:general ?origcommon . ?resource hh:general ?common . ?resource envirofi:hasCommonMisidentification ?misid .?resource0 taxmeon:completeTaxonName \"" + capitalizeFirst( tax ) + "\" . ?resource taxmeon:hasVernacularName ?vern . ?vern rdfs:label ?label . FILTER ( ?resource0 != ?resource ) . FILTER (lang(?label) = \"" + lang + "\") }";
			}
			
			/** get propable misidentifications	*/
			$.ajax({
			  url: "relay_JSON.php",
			  data: { url: sparql_url + 
					encodeURIComponent( sparqlQuery ) },
			  success: function(data) {
				var obj = $.parseJSON(data);
				
				var r = document.getElementById("resultHolder");
				var misid_str = '';
				
				if (obj.results.hasOwnProperty( 'result' )) {
					if (!obj.results.result.hasOwnProperty( 'binding' ))
						misid_str += speciesLinks( tax, false, obj.results.result[ 0 ].binding[ 3 ].literal === 'true' ) + '<br />';
					else
						misid_str += speciesLinks( tax, false, obj.results.result.binding[ 3 ].literal === 'true' ) + '<br />';
				}
				
				if (obj.results.hasOwnProperty( 'result' )) {
					if ( obj.results.result.length > 1 ) {
						if (lang == 'fi')
							misid_str += "Varo sekoittamasta lajeihin: <br />";
						else if (lang == 'en')
							misid_str += "Common misidentifications: <br />";
						for (x in obj.results.result) {
							misid_str += speciesLinks( obj.results.result[ x ].binding[ 1 ].literal, true, obj.results.result[ x ].binding[ 2 ].literal === 'true' );
							//misid_str += speciesLinks( obj.results.result[ x ].binding[ 1 ].literal, true, true );
						}
					}
					else {
						if (lang == 'fi')
							misid_str += "Varo sekoittamasta lajiin: ";
						else if (lang == 'en')
							misid_str += "Common misidentification: ";
						misid_str += speciesLinks( obj.results.result.binding[ 1 ].literal, true, obj.results.result.binding[ 2 ].literal === 'true' );
						//misid_str += speciesLinks( obj.results.result.binding[ 1 ].literal, true, true );
					}
				}
				else {
					misid_str += speciesLinks( tax, false, true ) + '<br />';
					if (lang == 'fi')
						misid_str += "Ei helposti sekoitettavissa muihin lajeihin";
					else if (lang == 'en')
						misid_str += "No common misidentifications";
				}
				
				if ( misid_str.length > 1 )
					r.innerHTML = misid_str;
					
				}
			});
			
			var r = document.getElementById("resultHolder2");
			r.innerHTML = '';

			/** create SPARQL-query for taxon-id */
			
			var sparqlQuery = "PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> PREFIX hh: <http://www.hatikka.fi/havainnot/> PREFIX taxmeon: <http://www.yso.fi/onto/taxmeon/> PREFIX xsd: <http://www.w3.org/2001/XMLSchema#> ";
			
			if ( !latinName ) {
				sparqlQuery += "SELECT ?resource WHERE { ?resource taxmeon:hasVernacularName ?vern . ?vern rdfs:label \"" + tax;
				sparqlQuery += "\"@" + lang;
				sparqlQuery += " .}";
			} else {
				sparqlQuery += "SELECT ?resource WHERE { ?resource taxmeon:completeTaxonName \"" + capitalizeFirst( tax );
				sparqlQuery += "\" .  }";
			}

			//console.log( sparqlQuery );
			
			/** get taxon-id */
			$.ajax({
			  url: "relay_JSON.php",
			  data: { url: sparql_url + 
					encodeURIComponent( sparqlQuery ) },
			  success: function(data) {
				
				var locstr = document.getElementById("locationInput").value;
				var locarr = locstr.split(' ');
				
				if (( locarr[ 0 ] == 'Latitude:') && (locarr[ 2 ] == 'Longitude:')) {
					userX = parseFloat ( locarr[ 3 ] );
					userY = parseFloat ( locarr[ 1 ] );
				} else {
					userX = null;
					userY = null;
				}
				
				taxId = $.parseJSON(data);
				taxId = taxId.results.result.binding.uri;
				
				if (taxId.length > 0) {
					if (userX !== null && userY != null)
						getProbs( taxId )
					else {
						googleLoc( locstr );
					}
				}
				
				
				/** Get location from Google Geocoding API */
				function googleLoc( place ) {
					$.ajax({
						url: "relay.php",
						data: { url: "http://maps.googleapis.com/maps/api/geocode/json?address=" + encodeURIComponent( place + ",finland" ) +
								"&sensor=false" },
						success: function(data) {
							var objGeocode = $.parseJSON(data);
							
							if ( objGeocode.status == "OK" ) {
								window.userX = objGeocode.results[ 0 ].geometry.location.lng.toFixed(4);
								window.userY = objGeocode.results[ 0 ].geometry.location.lat.toFixed(4);
							}
							
							console.log( window.userX );
							
							getProbs( window.taxId );
							/*updateHitStatus( odds );
							createSendButton( true );*/
						}
					});
				}
				
				
				/** Create 'Send' and 'Back' buttons */
				function createSendButton ( googled, color ) {
					var butt = '';
					/*butt += '<a data-inline="true" data-role="button" onClick="window.location.hash = \'#\'" href="#"';
					butt += '" data-theme="c"><span class="ui-btn-text transl" data-fi="Takaisin" data-en="Back">';
					if (lang == 'en')
						butt += 'Back';
					else
						butt += 'Takaisin';
					butt +='</span></a>';*/

					//butt += "<img src=\"img/" + color + ".png\" />";
					
					butt += '<a data-inline="true" data-role="button" target="_new" href="tiira/?laji=' + encodeURIComponent( tax ) + '&pvm=' + encodeURIComponent( date + '.' + month + '.' + year ) + '&lat=' + encodeURIComponent( userY ) + '&lon=' + encodeURIComponent( userX );
					if (googled == true)
						butt += '&paikka=' + encodeURIComponent( locstr );
					butt += '"';
					
					if ( color == 'red' ) {
						if (lang == 'en')
							butt += ' title="Observing this species is unlikely"';
						else
							butt += ' title="Lajin havaitseminen epätodennäköistä"';
						butt += ' data-theme="f">';
					} else if ( color == 'green' ) {
						if (lang == 'en')
							butt += ' title="Observing species is likely"';
						else
							butt += ' title="Lajin havaitseminen todennäköistä"';
						butt += ' data-theme="g">';
					} else {
						if (lang == 'en')
							butt += ' title="Observing species is possible"';
						else
							butt += ' title="Lajin havaitseminen mahdollista"';
						butt += ' data-theme="e">';
					}
					//console.log( butt );
					
					butt += '<span class="ui-btn-text transl" data-fi="Lähetä" data-en="Send">';
					if (lang == 'en')
						butt += 'Send';
					else
						butt += 'Lähetä';
					butt +='</span></a>';

					$('#buttHolder').html( '<div id="innerButt" class="rightAlign"></div>' );
					
					$('#innerButt').html( butt ).trigger('create');
					//$('#innerButt').page();
				}
				
				function updateHitStatus( odds ) {
					if (lang == 'fi') {
						r.innerHTML = "Todennäköisyys lajin havaitsemiselle: " + (100*odds).toFixed(1) +"%";
						r.innerHTML += "<br /><i>Koordinaatit: " + userY + ", " + userX + "</i>";
					} else {
						r.innerHTML = "Probability for observing species in the area: " + (100*odds).toFixed(1) +"%";
						r.innerHTML += "<br /><i>Coordinates: " + userY + ", " + userX + "</i>";
					}
				}
						
				
				/** get propability for seeing the species here and now */
				function getProbs ( taxId ) {
					var param = "http://demo.seco.tkk.fi/json?" + 'lat=' + encodeURIComponent( userY ) + '&lng=' + encodeURIComponent( userX ) + '&d=' + selectedDate.getDOY() + '&uri=' + encodeURIComponent( taxId );
					if ( biotope.length > 2 )
						param += "&biotope=" + biotope;
						
					$.ajax({
					  url: "relay.php",
					  data: { url: param
							},
					  dataType: "text",
					  error: function() {
						if (userX !== null && userY != null) {
							createSendButton( false, 'yellow' );
						}						  
					  }, 
					  success: function(data) {
						
						try	{
							var obj = $.parseJSON(data);
						}
						catch( e ) {
							var obj = [ -1 ];
						}
						var hit = false;
						var coords;
						
						//console.log( obj[ 0 ] );
						
						if (userX !== null && userY != null) {
							if (( obj[ 0 ] >= 0 ) && ( obj[ 0 ] < 2 ))
								updateHitStatus( obj[ 0 ] );
							createSendButton( false, obj[ 1 ] );
						}
						
						}
					});
				}
			}
			});
			
		}
		
		/** Geolocation stuff */
		
		function displayPosition(position) {
			var lat = position.coords.latitude.toFixed(4);
			var lon = position.coords.longitude.toFixed(4);
			$('#locationInput')[ 0 ].value = 'Latitude: ' + lat +
		  		", Longitude: " + lon;
		}
		
		function displayError() {
		  $('#locationInput')[ 0 ].value = 'Unable to get current location';
		}
		
		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition( displayPosition, displayError, {enableHighAccuracy: true, timeout:45000, maximumAge: 60000});
		}

	/*if (lang == 'fi') {
		document.write('\u003cscript language=\u0022javascript\u0022 src=\u0022jquery-ui/js/jquery.ui.datepicker-fi.js\u0022>\u003c/script>');
	}*/
	</script>
	<!--<script src="jquery-ui/js/jquery.ui.datepicker-fi.js"></script>-->
</div>		
</body>
</html>
