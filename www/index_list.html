<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />

    <title>Havainnon syöttö</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="" />
    <meta name="author" content="" />

    <link href="jquery-ui/css/ui-lightness/jquery-ui-1.8.21.custom.css" rel="stylesheet">
    <link href="jquery.mobile-1.1.0.min.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

	<script src="jquery/jquery-1.7.2.min.js"></script>
	<script src="jquery-ui/js/jquery-ui-1.8.21.custom.min.js"></script>
	<script src="jquery.mobile-1.1.0.min.js"></script>
	
	<style type="text/css">
	.rightAlign {
		text-align:right;
		}
    html { background-color: #F8F0F0; }
    </style>
    <style type='text/css'>
    <!--
        @media only screen and (min-width: 801px){
            .ui-page {
                width: 700px !important;
                margin: 0 auto !important;
                position: relative !important;
                border-right: 1px #CCCCCC solid !important;
                border-left: 1px #CCCCCC solid !important;
            }
        }
    -->
	</style>

  </head>

<body>
<div  data-role="page" class="type-home" id="main">
    <div id="headDiv" data-role="header" data-theme="e">
		<h1 class="ui-title transl" data-fi="Havainto" data-en="Observation"></h1>
    </div>

	<div class="ui-body ui-body-b" id="mainDiv">
		<label for="taxonInput" class="transl" data-fi="Laji" data-en="Species"></label>
		<input id="taxonInput" class="ui-autocomplete-input" disabled="true" />
		<label for="locationInput" class="transl" data-fi="Paikka" data-en="Location"></label>
		<input id="locationInput" type="text" />
		<label for="datepicker" class="select transl" data-fi="Aika" data-en="Date"></label>
		<input name="date1" id="datepicker" type="text" />
		
		<label for="select-choice-1" class="select transl" data-fi="Biotooppi" data-en="Biotope"></label>
		<select name="biotope" id="select-choice-1" data-mini="true" data-theme="c" disabled="true">
			<option value="-"></option>
			<option value="saaristo" class="transl" data-fi="ulkosaaristo" data-en="archipelago"></option>
			<option value="meri" class="transl" data-fi="meri" data-en="sea"></option>
			<option value="vesisto" class="transl" data-fi="järvi/joki" data-en="lake/river"></option>
			<option value="tunturi" class="transl" data-fi="tunturi" data-en="fell"></option>
			<option value="metsa" class="transl" data-fi="metsä" data-en="forest"></option>
			<option value="pelto" class="transl" data-fi="pelto/avomaa" data-en="field"></option>
			<option value="suo" class="transl" data-fi="suo" data-en="bog"></option>
			<option value="asutus" class="transl" data-fi="asutus" data-en="urban area"></option>
		</select>
			<!--<option value="saaristo"><div class="transl" data-fi="ulkosaaristo" data-en="Archipelago"></div></option>
			<option value="meri"><div class="transl" data-fi="meri" data-en="Sea"></div></option>
			<option value="vesisto"><div class="transl" data-fi="järvi/joki" data-en="lake/river"></div></option>-->
		<!--<fieldset data-role="controlgroup" data-type="horizontal" data-mini="true" id="biotope"> 
			<input type="radio" name="radio-choice-1" id="radio-choice-1" value="saaristo" checked="checked" />
			<label for="radio-choice-1">ulkosaaristo</label>
			<input type="radio" name="radio-choice-1" id="radio-choice-2" value="meri"  />
			<label for="radio-choice-2">meri</label>
			<input type="radio" name="radio-choice-1" id="radio-choice-3" value="vesisto"  />
			<label for="radio-choice-3">järvi/joki</label>
			<input type="radio" name="radio-choice-1" id="radio-choice-4" value="tunturi"  />
			<label for="radio-choice-4">tunturi</label>
			<input type="radio" name="radio-choice-1" id="radio-choice-5" value="metsa"  />
			<label for="radio-choice-5">metsä</label>
			<input type="radio" name="radio-choice-1" id="radio-choice-6" value="pelto"  />
			<label for="radio-choice-6">pelto/avomaa</label>
			<input type="radio" name="radio-choice-1" id="radio-choice-7" value="suo"  />
			<label for="radio-choice-7">suo</label>
			<input type="radio" name="radio-choice-1" id="radio-choice-8" value="asutus"  />
			<label for="radio-choice-8">asutus</label>
		</fieldset>-->
		
		<div class="ui-grid-a">
			<div class="ui-block-a">
				<a data-inline="true" data-role="button" href="#" onClick="getResults();" data-theme="e" id="searchDone">
					<span class="ui-btn-text transl" data-fi="Hae lajien todennäköisyydet" data-en="Get probabilities for species"></span>
				</a>
			</div>
			<div class="ui-block-b rightAlign">
				<a data-inline="true" data-role="button" href="#" onClick="langEn();" data-theme="c" id="engBut">
					<span class="ui-btn-text">in english</span>
				</a>
				<a data-inline="true" data-role="button" href="#" onClick="langFi();" data-theme="c" id="finBut">
					<span class="ui-btn-text">suomeksi</span>
				</a>
			</div>
			<!--<div class="ui-block-b rightAlign tilaa">
				<fieldset data-role="controlgroup" data-type="horizontal" data-mini="true" class="rightAlign tilaa">
					<input type="radio" name="radio-choice-1" id="radio-choice-1" onClick="langEn();" value="en" checked="checked" class="rightAlign tilaa" />
					<label for="radio-choice-1">in english</label>
					<input type="radio" name="radio-choice-1" id="radio-choice-2" onClick="langFi();" value="fi" class="rightAlign tilaa" />
					<label for="radio-choice-2">suomeksi</label>			
				</fieldset>
			</div>-->
		</div>
		
	</div>
	<div class="ui-body ui-body-b" id="details">
		<p id="speciesHolder"></p>
		<p id="resultHolder"></p>
		<p id="resultHolder2"></p>
		<p id="buttHolder"></p>
	</div>
</div>

	<script>
		Date.prototype.getDOY = function() {
			var onejan = new Date(this.getFullYear(),0,1);
			return Math.ceil((this - onejan) / 86400000);
		} 
		//var p = $("#test2");

		var sparql_url = "mt08014.seco.hut.fi:9080/smetana/service/data/moimoi/sparql?query=";
		
		var d = new Date();
		var year = d.getFullYear();
		var month = (d.getMonth() + 1);
		var date = d.getDate();
		
		var lang;
		
		var speciesLat = [];
		var speciesEn = [];
		var speciesFi = [];
		
		var userX;
		var userY;
		var taxId;
		
		langEn();
		
		/** Set language to finnish */
		function langFi() {
			$('.transl').each( function() {
				$(this).html( $(this).data('fi'));
			});
			lang = 'fi';
			//$('#engBut').show();
			//$('#engBut')[0].onclick = function() { alert('foo'); };
			//$('#finBut').hide();
			$("#taxonInput").autocomplete({
				minLength: 2,
				source: speciesFi.concat( speciesLat )
			});
			
			$('#select-choice-1')[ 0 ].value = '-';
			
			$.getScript("jquery-ui/js/jquery.ui.datepicker-fi.js", function(){ });

		}
		
		/** Set language to english */
		function langEn() {
			$('.transl').each( function() {
				$(this).html( $(this).data('en'));
			});
			lang = 'en';
			//$('#finBut').show();
			//$('#engBut').hide();
			$("#taxonInput").autocomplete({
				minLength: 2,
				source: speciesEn.concat( speciesLat )
			});

			$.getScript("jquery-ui/js/jquery.ui.datepicker-en-GB.js", function(){ });
		}
		
		/** Datepicker code */
		$( "#datepicker" ).datepicker({ dateFormat: "dd.mm.yy" });
		$('div.ui-datepicker').css({ fontSize: '12px' });
		
		if (date.toString().length == 1)
			date = "0" + date;
		if (month.toString().length == 1)
			month = "0" + month;
			
		
		$(document).bind('mobileinit', function () {
			$.mobile.hashListeningEnabled = false;
			$.mobile.linkBindingEnabled = false;
		});
		
		/** Get the HTML DOM Object from jQuery Object and update with current date */
		$( "#datepicker" )[0].value = date + "." + month + "." + year;
		
		/** Get latin taxon-names */
		$.ajax({
			url: "relay_JSON.php",
			data: { url: sparql_url + 
				encodeURIComponent("PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> PREFIX taxmeon: <http://www.yso.fi/onto/taxmeon/> PREFIX taxonomic-ranks: <http://www.yso.fi/onto/taxonomic-ranks/>" + 
				"SELECT DISTINCT ?label WHERE { ?resource rdf:type taxmeon:TaxonInChecklist . ?resource rdf:type taxonomic-ranks:Species . ?resource rdfs:label ?label . FILTER (lang(?label) != \"en\" && lang(?label) != \"fi\") } " + 
				"ORDER BY ?label") },
			success: function(data) {
				var obj = $.parseJSON(data);

				for (x in obj.results.result) {
					speciesLat.push( obj.results.result[ x ].binding.literal.toLowerCase() );
				}

				$("#taxonInput").autocomplete({
					minLength: 2,
					source: speciesEn.concat( speciesLat )
					/*source: function(req, responseFn) {
						var re = $.ui.autocomplete.escapeRegex(req.term);
						var matcher = new RegExp( "^" + re, "i" );
						var a = $.grep( species, function(item,index){
							return matcher.test(item);
						});
						responseFn( a );
					}*/
				});
			}
		});
		
		/** Get english taxon-names */
		$.ajax({
			url: "relay_JSON.php",
			data: { url: sparql_url + 
				encodeURIComponent("PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> PREFIX taxmeon: <http://www.yso.fi/onto/taxmeon/> PREFIX taxonomic-ranks: <http://www.yso.fi/onto/taxonomic-ranks/>" + 
				"SELECT DISTINCT ?label WHERE { ?resource rdf:type taxmeon:VernacularName . ?resource taxmeon:inverse_of_hasVernacularName ?resource0 . ?resource0 rdf:type taxonomic-ranks:Species . ?resource rdfs:label ?label . FILTER (lang(?label) = \"en\") } " + 
				"ORDER BY ?label ") },
			success: function(data) {
				var obj = $.parseJSON(data);

				for (x in obj.results.result) {
					speciesEn.push( obj.results.result[ x ].binding.literal.toLowerCase() );
				}

				$("#taxonInput").autocomplete({
					minLength: 2,
					source: speciesEn.concat( speciesLat )
					/*source: function(req, responseFn) {
						var re = $.ui.autocomplete.escapeRegex(req.term);
						var matcher = new RegExp( "^" + re, "i" );
						var a = $.grep( species, function(item,index){
							return matcher.test(item);
						});
						responseFn( a );
					}*/
				});
			}
		});
		
		/** Get finnish taxon-names */
		$.ajax({
			url: "relay_JSON.php",
			data: { url: sparql_url + 
				encodeURIComponent("PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> PREFIX taxmeon: <http://www.yso.fi/onto/taxmeon/> PREFIX taxonomic-ranks: <http://www.yso.fi/onto/taxonomic-ranks/>" + 
				"SELECT DISTINCT ?label WHERE { ?resource rdf:type taxmeon:VernacularName . ?resource taxmeon:inverse_of_hasVernacularName ?resource0 . ?resource0 rdf:type taxonomic-ranks:Species . ?resource rdfs:label ?label . FILTER (lang(?label) = \"fi\") } " + 
				"ORDER BY ?label ") },
			success: function(data) {
				var obj = $.parseJSON(data);

				for (x in obj.results.result) {
					speciesFi.push( obj.results.result[ x ].binding.literal.toLowerCase() );
				}

				/*$("#taxonInput").autocomplete({
					minLength: 2,
					source: speciesFi
				});*/
			}
		});


		/** Get results from form */
		function getResults() {
			
			var loc = "";

			var tax = document.getElementById("taxonInput").value.toLowerCase();
			var latinName = false;
			
			if ( $.inArray( tax, speciesLat ) != -1 ) {
				latinName = true;
			}
			
			if (document.getElementById("locLat") !== null) {
				loc = "Lat: " + document.getElementById("locLat").value + 
					" Lon: " + document.getElementById("locLon").value;
			} else {
				loc = document.getElementById("locationInput").value;
			}

			var dateArr = document.getElementById("datepicker").value.split('.');
			
			date = dateArr[ 0 ];
			month = dateArr[ 1 ];
			year = '2012';
			selectedDate = new Date( year, month, date, 0, 0, 0, 0 );

			if (date.toString().length == 1)
				date = "0" + date;
			if (month.toString().length == 1)
				month = "0" + month;

			
			/** Capitalize all separate words */
			function capitalizeWords(strSentence) {
				var s = strSentence.replace(/\s[a-z]/g, convertToUpper);
				s = s[ 0 ].toUpperCase() + s.substring(1);

				return s;
			 
				function convertToUpper() {
					return arguments[0].toUpperCase();
				}
			}
			
			/** Capitalize all separate words */
			function capitalizeFirst(strSentence) {
				return strSentence[ 0 ].toUpperCase() + strSentence.substring(1);
			}
			
			/** Generate misid-text */
			function speciesLinks( speciesName, bLink, bLuontoPortti ) {
				var thisStr = '';
				
				if ( bLink )
					thisStr = '<a href href="#" onClick="changeTaxon(\'' + speciesName + '\');">';
				else
					thisStr = '<b>';
					
				if (lang == 'en')
					thisStr += capitalizeWords( speciesName );
				else
					thisStr += speciesName;
					
				if ( bLink )
					thisStr += '</a>';
				else
					thisStr += '</b>';
				
				var speciesLP = speciesName.replace(/ä/g, "a").replace(/ö/g, "o")
				if (lang == 'fi')
					speciesLP = speciesLP.replace('isokuovi','kuovi');
				else {
					speciesLP = speciesLP.split('/')[ 0 ];
					speciesLP = speciesLP.replace('wigeon','wigeon').replace('northern pintail', 'pintail').replace('common teal', 'teal');
					speciesLP = speciesLP.replace('barn swallow','swallow').replace('collared sand martin','sand martin');
					speciesLP = speciesLP.replace('eurasian ', '').replace('european ', '');
					speciesLP = speciesLP.replace(/ /g,'-');
				}
				
				var validTaxon = false;console.log( r.html );
				
				//if ( lang == 'en' && (($.inArray( tax, speciesEn ) != -1) || ($.inArray( tax, speciesLat ) != -1))) {
				if ( lang == 'en' && ($.inArray( tax, speciesEn ) != -1)) {
					validTaxon = true;
				}
			
				if ( lang == 'fi' && ($.inArray( tax, speciesFi ) != -1)) {
					validTaxon = true;
				}
			
				if ( validTaxon ) {
					thisStr += " &nbsp; <a href=\"http://" + lang + ".wikipedia.org/wiki/" + capitalizeWords( speciesName.split('/')[ 0 ] ) + "\" target=\"_blank\" title=\"Wikipedia\"> <img src=\"w.ico\" /></a>";
					//if (lang == 'fi')
					
					if ( bLuontoPortti )
						thisStr += "<a id=\"lp_" + speciesName + "\" href=\"http://www.luontoportti.com/suomi/" + lang + "/linnut/" + speciesLP + "\" target=\"_blank\" title=\"Luontoportti\"> <img src=\"lp.ico\" /></a>";
					//$('#lp_' + speciesName).hide();
					
					if (lang == 'fi')
						thisStr += " <a href=\"http://atlas3.lintuatlas.fi/tulokset/laji/" + speciesName + "\" target=\"_blank\" title=\"Lintuatlas\"> <img src=\"atlas.ico\" /></a>";				

					/** Check if we should display LuontoPortti-link */
					/*$.ajax({
						url: "relay_JSON.php",
						data: { url: sparql_url + 
								encodeURIComponent( 'PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> PREFIX envirofi: <http://www.yso.fi/onto/envirofi/> PREFIX taxmeon: <http://www.yso.fi/onto/taxmeon/> ' + 
													"ASK { ?vern rdfs:label \"" + speciesName + "\"@" + lang + " . ?vern taxmeon:inverse_of_hasVernacularName ?resource . ?resource <http://www.hatikka.fi/havainnot/general> true } " ) },
						success: function(data) {
							var obj = $.parseJSON(data);
							
							if (obj.boolean === 'true') {
								$('#lp_' + speciesName).show();
							}
						}
					})*/;
					
				}
				thisStr += "<br />";
				
				return thisStr;
			}

			/** create SPARQL-query for retrieving misidentifications */
			
			var sparqlQuery;
			
			if ( !latinName ) {
				sparqlQuery = "PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> PREFIX hh: <http://www.hatikka.fi/havainnot/> PREFIX envirofi: <http://www.yso.fi/onto/envirofi/> PREFIX taxmeon: <http://www.yso.fi/onto/taxmeon/> " + 
					"SELECT ?resource ?label ?common ?origcommon WHERE { ?resource0 envirofi:hasCommonMisidentification ?misid . ?resource0 hh:general ?origcommon . ?resource hh:general ?common . ?resource envirofi:hasCommonMisidentification ?misid . ?vern0 taxmeon:inverse_of_hasVernacularName ?resource0 . ?vern0 rdfs:label \"" + tax + "\"@" + lang + " . ?resource taxmeon:hasVernacularName ?vern . ?vern rdfs:label ?label . FILTER ( ?resource0 != ?resource ) . FILTER (lang(?label) = \"" + lang + "\") }";
			} else {
				sparqlQuery = "PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> PREFIX envirofi: <http://www.yso.fi/onto/envirofi/> PREFIX taxmeon: <http://www.yso.fi/onto/taxmeon/> " + 
					"SELECT ?resource ?label WHERE { ?resource0 envirofi:hasCommonMisidentification ?misid . ?resource envirofi:hasCommonMisidentification ?misid .?resource0 taxmeon:completeTaxonName \"" + capitalizeFirst( tax ) + "\" . ?resource taxmeon:hasVernacularName ?vern . ?vern rdfs:label ?label . FILTER ( ?resource0 != ?resource ) . FILTER (lang(?label) = \"" + lang + "\") }";
			}


			/** ALL PROBS */
			if ( tax.length == 0) {
				getAllProbs();
			}
				
			/** get propability for seeing the species here and now */
			function getAllProbs () {
				var locstr = document.getElementById("locationInput").value;
				var locarr = locstr.split(' ');
				
				if (( locarr[ 0 ] == 'Latitude:') && (locarr[ 2 ] == 'Longitude:')) {
					userX = parseFloat ( locarr[ 3 ] );
					userY = parseFloat ( locarr[ 1 ] );
				} else {
					userX = null;
					userY = null;
				}
				
				$.ajax({
				  url: "relay.php",
				  data: { url: "http://demo.seco.tkk.fi/classes?" + 'lat=' + encodeURIComponent( userY ) + '&lng=' + encodeURIComponent( userX ) + '&d=' + selectedDate.getDOY()
						},
				  dataType: "text",
				  success: function(data) {
				
					var obj = $.parseJSON(data);
					var hit = false;
					var coords;
					
					/** Create 'Send' and 'Back' buttons */
					function createSendButton ( googled ) {
						var butt = '<div class="ui-grid-a"><div class="ui-block-a">';
						butt += '<a data-inline="true" data-role="button" onClick="window.location.hash = \'#\'" href="#"';
						butt += '" data-theme="c"><span class="ui-btn-text transl" data-fi="Takaisin" data-en="Back">';
						if (lang == 'en')
							butt += 'Back';
						else
							butt += 'Takaisin';
						butt +='</span></a>';
						butt += '</div>';

						butt += '<div class="ui-block-b rightAlign">';
						butt += '</div></div>';

						$('#buttHolder').html( butt );
						$('#details').trigger('create');
					}
					
					/** check if user coords are within given area */
					function updateHitStatus( odds ) {
						
						var r = document.getElementById("resultHolder2");
						r.innerHTML = "";
						//r.innerHTML = "<table>        <tr>            <td>Heading1</td>            <td>Meaning1</td>        </tr>        <tr>            <td>Heading2</td>            <td>Meaning2</td>        </tr>        <tr>            <td>Heading3</td>            <td>Meaning3</td>        </tr>    </table><table>        <tr>            <td>Heading1</td>            <td>Meaning1</td>        </tr>        <tr>            <td>Heading2</td>            <td>Meaning2</td>        </tr>        <tr>            <td>Heading3</td>            <td>Meaning3</td>        </tr>    </table>";						
						
						/*r.innerHTML = "<table>";
						for (xx in obj) {
							//console.log ( obj[ xx ][ yy ] );
							
							r.innerHTML += "<tr>";
							if (lang == 'en') {
								r.innerHTML += "<td>" + capitalizeWords( obj[ xx ][ 3 ] ) + "</td><td>" + obj[ xx ][ 4 ] + "</td><td>" + obj[ xx ][ 1 ] + "</td>";
							} else {
								r.innerHTML += "<td>" + capitalizeFirst( obj[ xx ][ 2 ] ) + "</td><td>" + obj[ xx ][ 4 ] + "</td><td>" + obj[ xx ][ 1 ] + "</td>";
							}
							r.innerHTML += "</tr>";
						}
						r.innerHTML += "</table>";*/
						
						for (xx in obj) {
							//console.log ( obj[ xx ][ yy ] );
							
							if (lang == 'en') {
								r.innerHTML += capitalizeWords( obj[ xx ][ 3 ] ) + " - " + obj[ xx ][ 4 ] + " - " + obj[ xx ][ 1 ] + "<br />";
							} else {
								r.innerHTML += capitalizeFirst( obj[ xx ][ 2 ] ) + " - " + obj[ xx ][ 4 ] + " - " + obj[ xx ][ 1 ] + "<br />";
							}
						}
						//console.log( r.innerHTML );
					}
					
					if (data.length > 0) {
						
						if (userX !== null && userY != null) {
							//console.log ( obj );

							updateHitStatus( data );
							//createSendButton( false );
						}
					}
					
					}
				});
			}
						
		}
		
		/** Geolocation stuff */
		
		function displayPosition(position) {
			var lat = position.coords.latitude.toFixed(4);
			var lon = position.coords.longitude.toFixed(4);
			$('#locationInput')[ 0 ].value = 'Latitude: ' + lat +
		  		", Longitude: " + lon;
		}
		
		function displayError() {
		  $('#locationInput')[ 0 ].value = 'Unable to get current location';
		}
		
		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition( displayPosition, displayError, {enableHighAccuracy: true, timeout:45000, maximumAge: 60000});
		}

	/*if (lang == 'fi') {
		document.write('\u003cscript language=\u0022javascript\u0022 src=\u0022jquery-ui/js/jquery.ui.datepicker-fi.js\u0022>\u003c/script>');
	}*/
	</script>
	<!--<script src="jquery-ui/js/jquery.ui.datepicker-fi.js"></script>-->
</body>
</html>
